<html>
<head>
  <meta charset="utf-8">

  <script src="http://cdn.peerjs.com/0.3/peer.min.js"></script>
  <script src="socket.io/socket.io.js"> </script>
  <script type = "text/javascript"> 

  	// var serverAddress = 'http://ec2-54-200-21-15.us-west-2.compute.amazonaws.com:8080/';
  	var serverAddress = 'http://localhost:8080/';
    var mystream = null;
    var peers = null;
    var peerIndex = 0;
    var peer_id = null;
    var peer = null;
    var videoData =null;
    var dataConn = null;
    var socket = null;
    
    /* PeerJS functions*/
    var newPeer = function(peer_ids){

      console.log("Got a new peer: " + peer_ids);

      peers=peer_ids;
      // Call them with our stream, my_stream
      console.log("Calling peer: " + peer_ids);           
      var call = peer.call(peer_ids, mystream);
      
      console.log("Establishing connection with user: " + peer_ids);           

      // After they answer, we'll get a 'stream' event with their stream  
      call.on('stream', function(remoteStream) {
        console.log("Got remote stream ");
        var ovideoElement = document.createElement('video');
            ovideoElement.src = window.URL.createObjectURL(remoteStream) || remoteStream;
            document.body.appendChild(ovideoElement);
            ovideoElement.play();
        // var videoElement = document.getElementById('otherVideo');
  
        // videoElement.src = window.URL.createObjectURL(remoteStream) || remoteStream;
      });
    }  
    var peerOpen =  function(id) {
        console.log('My peer ID is: ' + id);
        peer_id = id;
       
        console.log("sending out our peer id");
        socket.emit("peer_id",peer_id);        
	}
	var peerIncomingCall =  function(incoming_call) {
        console.log("Got a call!");
        console.log("sending" + mystream);

        incoming_call.answer(mystream); // Answer the call with our stream from getUserMedia
        incoming_call.on('stream', function(remoteStream) {  // we receive a getUserMedia stream from the remote caller
          // And attach it to a video object
          var ovideoElement = document.createElement('video');
            ovideoElement.src = window.URL.createObjectURL(remoteStream) || remoteStream;
            document.body.appendChild(ovideoElement);
            ovideoElement.play();
        });
    }
    var peerConnection = function(incoming_data){
      console.log("Got a data  from user");
      console.log(incoming_data);
      // console.log(incoming_data);
      // peers = peer.connections[0];
      incoming_data.on('data',function(data){
        videoData = data;
      });
      
      incoming_data.on('error',function(err){
          console.log(err);        
      });
    }
                  

    var init = function(){
		window.URL = window.URL || window.webkitURL || window.mozURL || window.msURL;
	    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

	    if (navigator.getUserMedia) {

	    	navigator.getUserMedia({video: true, audio: true}, 
            function(stream) {
	          	mystream = stream;
	          	console.log(mystream);
	          	console.log('here');
	          	var videoElement = document.getElementById('myVideo');
	          	videoElement.src = window.URL.createObjectURL(stream) || stream;
	          	videoElement.play();

				/* Socket Server - Socket.io */
	        	socket = io.connect(serverAddress);  
	        	socket.on('connect', function() {
		      		console.log("Connected");
				});

				// Receive other folks peer_ids
				socket.on('peer_id', newPeer );   

				/* Peer JS */
				peer = new Peer({key: 'c9tm16hc72t0ggb9'});
				// Get an ID from the PeerJS server   
				peer.on('open',peerOpen);           
				peer.on('call',peerIncomingCall);
				peer.on('connection', peerConnection);                 

	    	}, function(err) {
        		console.log('Failed to get local stream' ,err);
        	});
		}
	    
    }


  </script>
</head>


<body onload ="init()">
<video id="myVideo" width="320" height="240"  ></video>
<!-- <video id="otherVideo" width="320" height="240"  ></video> -->
</body>
 
</html>